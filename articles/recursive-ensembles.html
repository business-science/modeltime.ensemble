<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forecasting with Recursive Ensembles • modeltime.ensemble</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Forecasting with Recursive Ensembles">
<meta property="og:description" content="modeltime.ensemble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-76139189-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-76139189-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">modeltime.ensemble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/getting-started-with-modeltime-ensemble.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Forecasting</li>
    <li>
      <a href="../articles/getting-started-with-modeltime-ensemble.html">Getting Started with Modeltime</a>
    </li>
    <li>
      <a href="../articles/recursive-ensembles.html">Recursive Ensemble Forecasting</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    API
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">API Functions</li>
    <li>
      <a href="../reference/index.html">
        <span class="fas fa-home"></span>
         
        Function Reference
      </a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Change History</li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Ecosystem
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Forecast</li>
    <li>
      <a href="https://business-science.github.io/modeltime/">Modeltime (Forecasting)</a>
    </li>
    <li>
      <a href="https://business-science.github.io/timetk/">TimeTK (Time Series Analysis)</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Improve</li>
    <li>
      <a href="https://business-science.github.io/modeltime.ensemble/">Modeltime Ensemble (Blending Forecasts)</a>
    </li>
    <li>
      <a href="https://business-science.github.io/modeltime.resample/">Modeltime Resample (Backtesting)</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Scale</li>
    <li>
      <a href="https://business-science.github.io/modeltime.h2o/">Modeltime H2O (AutoML)</a>
    </li>
    <li>
      <a href="https://business-science.github.io/modeltime.gluonts/">Modeltime GluonTS (Deep Learning)</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://university.business-science.io/p/ds4b-203-r-high-performance-time-series-forecasting/">
    <span class="fas fa-graduation-cap"></span>
     
    Learn
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/business-science/modeltime.ensemble">
    <span class="fab fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="recursive-ensembles_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Forecasting with Recursive Ensembles</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/business-science/modeltime.ensemble/blob/master/vignettes/recursive-ensembles.Rmd"><code>vignettes/recursive-ensembles.Rmd</code></a></small>
      <div class="hidden name"><code>recursive-ensembles.Rmd</code></div>

    </div>

    
    
<div id="what-is-a-recursive-model" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is-a-recursive-model" class="anchor"></a>What is a Recursive Model?</h1>
<p>A <em>recursive model</em> uses predictions to generate new values for independent features. These features are typically lags used in autoregressive models.</p>
</div>
<div id="why-is-recursive-needed-for-autoregressive-models" class="section level1">
<h1 class="hasAnchor">
<a href="#why-is-recursive-needed-for-autoregressive-models" class="anchor"></a>Why is Recursive needed for Autoregressive Models?</h1>
<p>It’s important to understand that a recursive model is only needed when using lagged features with a <strong>Lag Size &lt; Forecast Horizon.</strong> When the lag length is less than the forecast horizon, a problem exists were missing values (<code>NA</code>) are generated in the future data.</p>
<p>A solution that <code><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">recursive()</a></code> implements is to iteratively fill these missing values in with values generated from predictions. This technique can be used for:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Single ensemble recursive predictions</strong> - Effectively turning any <code>ensemble</code> model into an Autoregressive (AR) model</p></li>
<li><p><strong>Panel ensembles recursive predictions</strong> - In many situations we need to forecast <strong>more than one time series</strong>. We can batch-process these with 1 model by processing time series groups as panels. This technique can be extended to recursive forecasting for scalable models (1 model that predicts many time series).</p></li>
</ol>
<p>Here’s an example of a panel forecast that uses a recursive ensemble with a Linear Regression and MARS model.</p>
<p><img src="panel-ensemble.jpg" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="single-ensemble-recursive-example" class="section level1">
<h1 class="hasAnchor">
<a href="#single-ensemble-recursive-example" class="anchor"></a>Single Ensemble Recursive Example</h1>
<blockquote>
<p>Use single ensembles to forecast a single time series</p>
</blockquote>
<p>First, we need to load the necessary libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/business-science/modeltime.ensemble">modeltime.ensemble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/business-science/modeltime">modeltime</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.users.sonic.net/earth/">earth</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/business-science/timetk">timetk</a></span><span class="op">)</span></code></pre></div>
<p>Next, we select a forecast horizon of 24 days and extend the data frame with the function <code><a href="https://rdrr.io/pkg/timetk/man/future_frame.html">future_frame()</a></code>. We do this to create a future dataset, which we can distinguish because its values will be NA.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">FORECAST_HORIZON</span> <span class="op">&lt;-</span> <span class="fl">24</span>

<span class="va">m750_extended</span> <span class="op">&lt;-</span> <span class="va">m750</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/timetk/man/future_frame.html">future_frame</a></span><span class="op">(</span>
        .length_out <span class="op">=</span> <span class="va">FORECAST_HORIZON</span>,
        .bind_data  <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The next step is to create a recipe where we specify the formula we are going to use and create the lagged variables that our model will use. Notice that we create lags up to our forecast horizon.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recipe_lag</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">date</span>, <span class="va">m750_extended</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">step_lag</span><span class="op">(</span><span class="va">value</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">FORECAST_HORIZON</span><span class="op">)</span>

<span class="co"># Data Preparation</span>
<span class="va">m750_lagged</span> <span class="op">&lt;-</span> <span class="va">recipe_lag</span> <span class="op">%&gt;%</span> <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">juice</span><span class="op">(</span><span class="op">)</span>
<span class="va">m750_lagged</span></code></pre></div>
<pre><code>#&gt; # A tibble: 330 x 26
#&gt;    date       value lag_1_value lag_2_value lag_3_value lag_4_value lag_5_value
#&gt;    &lt;date&gt;     &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
#&gt;  1 1990-01-01  6370          NA          NA          NA          NA          NA
#&gt;  2 1990-02-01  6430        6370          NA          NA          NA          NA
#&gt;  3 1990-03-01  6520        6430        6370          NA          NA          NA
#&gt;  4 1990-04-01  6580        6520        6430        6370          NA          NA
#&gt;  5 1990-05-01  6620        6580        6520        6430        6370          NA
#&gt;  6 1990-06-01  6690        6620        6580        6520        6430        6370
#&gt;  7 1990-07-01  6000        6690        6620        6580        6520        6430
#&gt;  8 1990-08-01  5450        6000        6690        6620        6580        6520
#&gt;  9 1990-09-01  6480        5450        6000        6690        6620        6580
#&gt; 10 1990-10-01  6820        6480        5450        6000        6690        6620
#&gt; # … with 320 more rows, and 19 more variables: lag_6_value &lt;dbl&gt;,
#&gt; #   lag_7_value &lt;dbl&gt;, lag_8_value &lt;dbl&gt;, lag_9_value &lt;dbl&gt;,
#&gt; #   lag_10_value &lt;dbl&gt;, lag_11_value &lt;dbl&gt;, lag_12_value &lt;dbl&gt;,
#&gt; #   lag_13_value &lt;dbl&gt;, lag_14_value &lt;dbl&gt;, lag_15_value &lt;dbl&gt;,
#&gt; #   lag_16_value &lt;dbl&gt;, lag_17_value &lt;dbl&gt;, lag_18_value &lt;dbl&gt;,
#&gt; #   lag_19_value &lt;dbl&gt;, lag_20_value &lt;dbl&gt;, lag_21_value &lt;dbl&gt;,
#&gt; #   lag_22_value &lt;dbl&gt;, lag_23_value &lt;dbl&gt;, lag_24_value &lt;dbl&gt;</code></pre>
<p>We divide the data set into training dataset and future dataset:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">m750_lagged</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span>

<span class="va">future_data</span> <span class="op">&lt;-</span> <span class="va">m750_lagged</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, we are going to create two models that we will then join into an ensemble. The first model is a linear model while the second model is a MARS model. In a real scenario, we would typically do a pre-selection work where we would analyze more models and keep those with better performance to make the ensemble.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_fit_lm</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">fit</span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>

<span class="va">model_fit_mars</span> <span class="op">&lt;-</span> <span class="fu">mars</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">set_engine</span><span class="op">(</span><span class="st">"earth"</span>, endspan <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">fit</span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></code></pre></div>
<p>The next step is to create an ensemble of type mean (in which the predictions of the two models will be averaged) and right after that we use the <code><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">recursive()</a></code> function to create the recursive model. You can consult all the information of the function by typing in the console <code><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">?modeltime::recursive</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recursive_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_table.html">modeltime_table</a></span><span class="op">(</span>
    <span class="va">model_fit_lm</span>,
    <span class="va">model_fit_mars</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/ensemble_average.html">ensemble_average</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">recursive</a></span><span class="op">(</span>
        transform  <span class="op">=</span> <span class="va">recipe_lag</span>,
        train_tail <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">train_data</span>, <span class="va">FORECAST_HORIZON</span><span class="op">)</span>
    <span class="op">)</span>

<span class="va">recursive_ensemble</span></code></pre></div>
<pre><code>#&gt; Recursive [modeltime ensemble]
#&gt; 
#&gt; ── Modeltime Ensemble ───────────────────────────────────────────
#&gt; Ensemble of 2 Models (MEAN)
#&gt; 
#&gt; # Modeltime Table
#&gt; # A tibble: 2 x 3
#&gt;   .model_id .model   .model_desc
#&gt;       &lt;int&gt; &lt;list&gt;   &lt;chr&gt;      
#&gt; 1         1 &lt;fit[+]&gt; LM         
#&gt; 2         2 &lt;fit[+]&gt; EARTH</code></pre>
<p>Finally, we predict over our dataset and visualize the predictions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_table.html">modeltime_table</a></span><span class="op">(</span>
    <span class="va">recursive_ensemble</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_forecast.html">modeltime_forecast</a></span><span class="op">(</span>
        new_data <span class="op">=</span> <span class="va">future_data</span>,
        actual_data <span class="op">=</span> <span class="va">m750</span>
    <span class="op">)</span>

<span class="va">fcast</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/plot_modeltime_forecast.html">plot_modeltime_forecast</a></span><span class="op">(</span>
        .interactive <span class="op">=</span> <span class="cn">FALSE</span>,
        .conf_interval_show <span class="op">=</span> <span class="cn">FALSE</span>,
    <span class="op">)</span></code></pre></div>
<p><img src="recursive-ensembles_files/figure-html/unnamed-chunk-9-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="panel-ensemble-recursive-example" class="section level1">
<h1 class="hasAnchor">
<a href="#panel-ensemble-recursive-example" class="anchor"></a>Panel Ensemble Recursive Example</h1>
<blockquote>
<p>Use panel ensembles to batch forecast multimple time series</p>
</blockquote>
<p>First, we select a forecast horizon of 24 days and extend the data frame with the function <code><a href="https://rdrr.io/pkg/timetk/man/future_frame.html">future_frame()</a></code>. We do this to create a future dataset, which we can distinguish because its values will be NA.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">FORECAST_HORIZON</span> <span class="op">&lt;-</span> <span class="fl">24</span>

<span class="va">m4_extended</span> <span class="op">&lt;-</span> <span class="va">m4_monthly</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/timetk/man/future_frame.html">future_frame</a></span><span class="op">(</span>
        .length_out <span class="op">=</span> <span class="va">FORECAST_HORIZON</span>,
        .bind_data  <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Then we create a transformer function that will be in charge of generating the lags for each time series up to each forecasting horizon:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lag_transformer_grouped</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
    <span class="va">data</span> <span class="op">%&gt;%</span>
        <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/pkg/timetk/man/tk_augment_lags.html">tk_augment_lags</a></span><span class="op">(</span><span class="va">value</span>, .lags <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">FORECAST_HORIZON</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Then, we apply the function and divide the data into training and future set:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m4_lags</span> <span class="op">&lt;-</span> <span class="va">m4_extended</span> <span class="op">%&gt;%</span>
    <span class="fu">lag_transformer_grouped</span><span class="op">(</span><span class="op">)</span>

<span class="va">m4_lags</span></code></pre></div>
<pre><code>#&gt; # A tibble: 1,670 x 27
#&gt;    id    date       value value_lag1 value_lag2 value_lag3 value_lag4 value_lag5
#&gt;    &lt;fct&gt; &lt;date&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
#&gt;  1 M1    1976-06-01  8000         NA         NA         NA         NA         NA
#&gt;  2 M1    1976-07-01  8350       8000         NA         NA         NA         NA
#&gt;  3 M1    1976-08-01  8570       8350       8000         NA         NA         NA
#&gt;  4 M1    1976-09-01  7700       8570       8350       8000         NA         NA
#&gt;  5 M1    1976-10-01  7080       7700       8570       8350       8000         NA
#&gt;  6 M1    1976-11-01  6520       7080       7700       8570       8350       8000
#&gt;  7 M1    1976-12-01  6070       6520       7080       7700       8570       8350
#&gt;  8 M1    1977-01-01  6650       6070       6520       7080       7700       8570
#&gt;  9 M1    1977-02-01  6830       6650       6070       6520       7080       7700
#&gt; 10 M1    1977-03-01  5710       6830       6650       6070       6520       7080
#&gt; # … with 1,660 more rows, and 19 more variables: value_lag6 &lt;dbl&gt;,
#&gt; #   value_lag7 &lt;dbl&gt;, value_lag8 &lt;dbl&gt;, value_lag9 &lt;dbl&gt;, value_lag10 &lt;dbl&gt;,
#&gt; #   value_lag11 &lt;dbl&gt;, value_lag12 &lt;dbl&gt;, value_lag13 &lt;dbl&gt;, value_lag14 &lt;dbl&gt;,
#&gt; #   value_lag15 &lt;dbl&gt;, value_lag16 &lt;dbl&gt;, value_lag17 &lt;dbl&gt;, value_lag18 &lt;dbl&gt;,
#&gt; #   value_lag19 &lt;dbl&gt;, value_lag20 &lt;dbl&gt;, value_lag21 &lt;dbl&gt;, value_lag22 &lt;dbl&gt;,
#&gt; #   value_lag23 &lt;dbl&gt;, value_lag24 &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">m4_lags</span> <span class="op">%&gt;%</span>
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span>

<span class="va">future_data</span> <span class="op">&lt;-</span> <span class="va">m4_lags</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, we are going to create two models that we will then join into an ensemble. The first model is a linear model while the second model is a MARS model.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_fit_lm</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">fit</span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>

<span class="va">model_fit_mars</span> <span class="op">&lt;-</span> <span class="fu">mars</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">set_engine</span><span class="op">(</span><span class="st">"earth"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">fit</span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></code></pre></div>
<p>The next step is to create an ensemble of type mean (in which the predictions of the two models will be averaged) and right after that we use the <code><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">recursive()</a></code> function to create the recursive model. Note that unlike the previous example, in this case we have to pass to the recursive function the argument <code>id</code> and we have to use the <code><a href="https://rdrr.io/pkg/modeltime/man/panel_tail.html">panel_tail()</a></code> function to create the train_tail.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recursive_ensemble_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_table.html">modeltime_table</a></span><span class="op">(</span>
    <span class="va">model_fit_mars</span>,
    <span class="va">model_fit_lm</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/ensemble_average.html">ensemble_average</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"median"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/recursive.html">recursive</a></span><span class="op">(</span>
        transform  <span class="op">=</span> <span class="va">lag_transformer_grouped</span>,
        train_tail <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/panel_tail.html">panel_tail</a></span><span class="op">(</span><span class="va">train_data</span>, <span class="va">id</span>, <span class="va">FORECAST_HORIZON</span><span class="op">)</span>,
        id <span class="op">=</span> <span class="st">"id"</span>
    <span class="op">)</span>

<span class="va">recursive_ensemble_p</span></code></pre></div>
<pre><code>#&gt; Recursive [modeltime ensemble]
#&gt; 
#&gt; ── Modeltime Ensemble ───────────────────────────────────────────
#&gt; Ensemble of 2 Models (MEDIAN)
#&gt; 
#&gt; # Modeltime Table
#&gt; # A tibble: 2 x 3
#&gt;   .model_id .model   .model_desc
#&gt;       &lt;int&gt; &lt;list&gt;   &lt;chr&gt;      
#&gt; 1         1 &lt;fit[+]&gt; EARTH      
#&gt; 2         2 &lt;fit[+]&gt; LM</code></pre>
<p>Finally, we predict over our dataset and visualize the predictions:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_table.html">modeltime_table</a></span><span class="op">(</span>
    <span class="va">recursive_ensemble_p</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/modeltime_forecast.html">modeltime_forecast</a></span><span class="op">(</span>
        new_data <span class="op">=</span> <span class="va">future_data</span>,
        actual_data <span class="op">=</span> <span class="va">m4_lags</span>,
        keep_data <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>

<span class="va">fcast</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/modeltime/man/plot_modeltime_forecast.html">plot_modeltime_forecast</a></span><span class="op">(</span>
        .interactive <span class="op">=</span> <span class="cn">FALSE</span>,
        .conf_interval_show <span class="op">=</span> <span class="cn">FALSE</span>,
        .facet_ncol <span class="op">=</span> <span class="fl">2</span>
    <span class="op">)</span></code></pre></div>
<p><img src="recursive-ensembles_files/figure-html/unnamed-chunk-16-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>Recursive modeling can be applied to ensembles. But, this is just a small portion of everything that can be done…. If you want to get all the details, read on!</p>
<div id="take-the-high-performance-forecasting-course" class="section level2">
<h2 class="hasAnchor">
<a href="#take-the-high-performance-forecasting-course" class="anchor"></a>Take the High-Performance Forecasting Course</h2>
<blockquote>
<p>Become the forecasting expert for your organization</p>
</blockquote>
<p><a href="https://university.business-science.io/p/ds4b-203-r-high-performance-time-series-forecasting/" target="_blank"><img src="https://www.filepicker.io/api/file/bKyqVAi5Qi64sS05QYLk" alt="High-Performance Time Series Forecasting Course" width="100%" style="box-shadow: 0 0 5px 2px rgba(0, 0, 0, .5);"></a></p>
<p><a href="https://university.business-science.io/p/ds4b-203-r-high-performance-time-series-forecasting/"><em>High-Performance Time Series Course</em></a></p>
<div id="time-series-is-changing" class="section level3">
<h3 class="hasAnchor">
<a href="#time-series-is-changing" class="anchor"></a>Time Series is Changing</h3>
<p>Time series is changing. <strong>Businesses now need 10,000+ time series forecasts every day.</strong> This is what I call a <em>High-Performance Time Series Forecasting System (HPTSF)</em> - Accurate, Robust, and Scalable Forecasting.</p>
<p><strong>High-Performance Forecasting Systems will save companies by improving accuracy and scalability.</strong> Imagine what will happen to your career if you can provide your organization a “High-Performance Time Series Forecasting System” (HPTSF System).</p>
</div>
<div id="how-to-learn-high-performance-time-series-forecasting" class="section level3">
<h3 class="hasAnchor">
<a href="#how-to-learn-high-performance-time-series-forecasting" class="anchor"></a>How to Learn High-Performance Time Series Forecasting</h3>
<p>I teach how to build a HPTFS System in my <a href="https://university.business-science.io/p/ds4b-203-r-high-performance-time-series-forecasting"><strong>High-Performance Time Series Forecasting Course</strong></a>. You will learn:</p>
<ul>
<li>
<strong>Time Series Machine Learning</strong> (cutting-edge) with <code>Modeltime</code> - 30+ Models (Prophet, ARIMA, XGBoost, Random Forest, &amp; many more)</li>
<li>
<strong>Deep Learning</strong> with <code>GluonTS</code> (Competition Winners)</li>
<li>
<strong>Time Series Preprocessing</strong>, Noise Reduction, &amp; Anomaly Detection</li>
<li>
<strong>Feature engineering</strong> using lagged variables &amp; external regressors</li>
<li><strong>Hyperparameter Tuning</strong></li>
<li><strong>Time series cross-validation</strong></li>
<li>
<strong>Ensembling</strong> Multiple Machine Learning &amp; Univariate Modeling Techniques (Competition Winner)</li>
<li>
<strong>Scalable Forecasting</strong> - Forecast 1000+ time series in parallel</li>
<li>and more.</li>
</ul>
<p class="text-center" style="font-size:24px;">
</p>
<p>Become the Time Series Expert for your organization.</p>

<p><br></p>
<p class="text-center" style="font-size:30px;">
</p>
<p><a href="https://university.business-science.io/p/ds4b-203-r-high-performance-time-series-forecasting">Take the High-Performance Time Series Forecasting Course</a></p>

</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Dancho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
